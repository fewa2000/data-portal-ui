# Claude Code Instructions — Data Portal UI (DB-ready)

You are a senior software architect and Streamlit developer.

You are working inside an existing Streamlit-based Data Portal UI project.
Your task is to EVOLVE the current application, not rewrite it from scratch.

This Data Portal is designed to be **database-driven**. The UI was initially built with mock data,
but the architecture must support switching to PostgreSQL-backed queries by changing **only the service layer**.

────────────────────────────────────────
CORE ARCHITECTURAL PRINCIPLES (MANDATORY)
────────────────────────────────────────

1) READ-ONLY PORTAL
- No data mutation
- No KPI calculations in Streamlit
- No pandas-based filtering/aggregation for KPIs

2) DATABASE-FIRST CONTRACT
- Domains define Gold tables and supported filters
- Filters translate to SQL WHERE clauses
- KPI calculations happen in SQL (eventually executed in Postgres)

3) SEPARATION OF CONCERNS (NON-NEGOTIABLE)
- UI rendering: pages/ + components/
- State handling: services/state.py
- Data access / execution: services/api.py
- Domain contracts & data models: models/

4) NO AGENTS, NO ORCHESTRATION, NO AI LOGIC
- Deterministic, explainable UI
- No n8n, no background jobs

────────────────────────────────────────
TARGET UI STRUCTURE
────────────────────────────────────────

Left navigation with three sections:
- Input
- Dashboards
- Archive

Global Domain selection must be visible:
- Sales
- Procurement
- Finance

All pages respect the selected domain.

────────────────────────────────────────
DOMAIN CONTRACTS (V1)
────────────────────────────────────────

Sales
- Gold table: mart.sales_orders_fact
- Filters:
  - order_date (date range)
  - region (multi-select)
  - product_category (multi-select)
  - channel (multi-select)

Procurement
- Gold table: mart.procurement_orders_fact
- Filters:
  - purchase_date (date range)
  - supplier (multi-select)
  - material_group (multi-select)
  - plant (multi-select)

Finance
- Gold table: mart.gl_postings_fact
- Filters:
  - posting_period (period range)
  - company_code (multi-select)
  - cost_center (multi-select)
  - account (multi-select)

Contracts must live in models/ and be reused by UI and service layer.

────────────────────────────────────────
SECTION BEHAVIOR REQUIREMENTS
────────────────────────────────────────

1) Input (Data Sources) — Read-only transparency
- Show the Gold table for the selected domain
- Show schema (columns + data types) (from DB if available, else mocked)
- Show a small preview (LIMIT N rows) (from DB if available, else mocked)
- List available filter options (distinct values) (from DB if available, else mocked)
- No execution in this section

2) Dashboards (Run Execution)
- Render domain-specific filter controls based on the domain contract
- Show SQL preview for transparency (generated by service layer)
- Execute a Run through the service layer (mock or DB-backed)
- Display results: KPI cards + trends + breakdowns (render only)

Definition: A Run consists of:
- domain
- filters
- executed_at timestamp
- sql_preview
- results (KPIs + chart-ready series)

3) Archive (Historical Runs)
- List completed runs stored in session state
- Filter by domain or show all
- Re-open any run (read-only) and show:
  - original filters
  - SQL preview
  - results

────────────────────────────────────────
IMPLEMENTATION RULES
────────────────────────────────────────

- Prefer minimal, incremental changes.
- Keep pages thin; push logic into services/models.
- Do not duplicate domain rules in multiple files.
- Do not calculate KPIs in the UI.
- If logic could live in SQL later, it must not live in the UI now.

────────────────────────────────────────
DB INTEGRATION GUIDANCE
────────────────────────────────────────

- The UI must call services/api.py for:
  - get_table_preview(domain)
  - get_schema(domain)
  - get_available_filter_values(domain, filter_name)
  - execute_run(domain, filters)  # returns sql_preview + results

- Switching from mock to database must be possible by changing ONLY the implementation
  inside services/api.py (and optional db connection helper), without changing UI pages/components.

Proceed carefully and professionally.
